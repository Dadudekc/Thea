  *   Reaching the end of a planned sequence without proactively starting the next cycle (e.g., Proactive Task Discovery).
  *   **Implicit Continuation:** After successfully completing a step that is part of a pre-agreed multi-step plan, sequence, or set of options where the next step is logically determined, agents MUST immediately proceed to that next step without requesting confirmation. Seeking confirmation after successful intermediate steps constitutes an unnecessary halt and violates loop integrity. Halts are only permissible upon explicit failure, encountering ambiguity requiring clarification, or completing the *entire* defined plan/task.
  *   **Transition After Completion:** Upon successful completion of an assigned task or multi-step plan, agents MUST immediately proceed to the next cycle of the Autonomous Loop (Step 1: Check Mailbox, Step 3: Check Task Queue). If no actionable messages or claimable tasks are found, agents MUST transition directly into the **Proactive Task Discovery** cycle (detailed in Section 3, Step 8) without halting or requesting further instructions.
      *   **Immediate Action Requirement:** This transition is not merely conceptual. The agent's response concluding the task **MUST** also contain the necessary tool call(s) to initiate the *very first step* of the next loop cycle (e.g., `list_dir` for the mailbox check) within the same turn, adhering to the **Atomicity of Intent and Action** principle. Stating task completion without initiating the next loop cycle's first action is a halt.
  *   **Seamless Sub-Step Execution:** When executing a task that involves multiple planned sub-steps (e.g., checking file size, then validating content, then performing an edit), agents MUST transition seamlessly from completing one sub-step to initiating the next *without any pause or request for confirmation*. Stating the plan for the next sub-step requires immediate execution of the corresponding tool call or action. Failure to execute immediately after stating intent constitutes a halt and violates loop integrity.
  *   **Atomicity of Intent and Action:** The principles of "Implicit Continuation", "Transition After Completion", and "Seamless Sub-Step Execution" mandate an **atomic relationship between stating intent and initiating action**. If an agent's response includes a statement about the next action it will take (e.g., "I will now read file X", "Executing Action 2: Validate JSON"), that response **MUST** also contain the corresponding tool call (`read_file`, `run_terminal_cmd`, etc.) to initiate that action *within the same turn*. Separating the statement of intent from the action execution into different conversational turns constitutes a halt and is a critical violation of loop integrity.
  *   **Pre-Turn Completion Check:** Before finalizing any response or concluding an action sequence, agents MUST perform a self-check: (1) Did I state an intended next action (sub-step, next task, loop continuation) without initiating it in this turn? (2) Did I complete a step without immediately queuing or initiating the next required action according to the current plan or loop protocol? If the answer to either is YES, the agent MUST correct its response/action queue to include the immediate initiation of the next required action before concluding the turn.
  *   **Mandatory Action Chaining:** When executing a multi-step plan or transitioning between loop phases (e.g., completing a task -> checking mailbox), the agent's response **MUST** explicitly state the *next* immediate action *and* include the tool call or execution logic for that action. If multiple actions can be performed sequentially within a single turn (e.g., running a script, then immediately logging the result), the agent MUST chain these actions. If the next action requires information *only available after the current action completes* (e.g., reading a file before editing it), the agent MUST state its intent to perform the *full sequence* and initiate the *first* action, ensuring the subsequent action follows immediately in the *next* turn upon receiving the required information. Pausing after completing *any* step without immediately initiating the next chained or logically subsequent action is a halt.
*   **Loop Integrity:** If a loop iteration fails (e.g., PBM error during discovery), log the error, attempt recovery if defined (e.g., direct execution), and immediately continue to the *next* iteration or defined fallback step. Do not halt the loop. **User queries should be processed as context within this flow, not break it.**

### 1.2 Edit Block Format

### 1.3 Handling Edit Failures
- **Retry:** If an `edit_file` operation fails verification (e.g., content mismatch, linter errors introduced), attempt a `reapply` call once.
- **Log Failure:** If `reapply` also fails, log the failure details (intended change, observed result, file path) in the agent's devlog and the central `tool_failures_index.md`.
- **WORKAROUND - Simple Overwrite:** If the failed edit was intended to *completely overwrite* a file with simple, known content (e.g., resetting a status file like `claim.json` to `{\"claimed_task_id\": null}`), and `edit_file` fails repeatedly, attempt the overwrite using `run_terminal_cmd` with the appropriate shell command (`Set-Content` for PowerShell/Windows, `echo ... >` for Bash/Linux) as a last resort. **Use extreme caution** with escaping and ensure the command is correct. Do *not* use this for complex edits or patching.
- **Block Task:** If the edit is complex or the workaround fails/is inapplicable, mark the task as blocked by tooling (`blocked-tool-failure`) and proceed to the next loop cycle step (mailbox check).

---

## 2. Tool Usage Guidelines
// ... existing code ... 